def label = "hello-${UUID.randomUUID().toString()}"
podTemplate(label: label,
        containers: [
        containerTemplate(name: 'maven', image: 'public.ecr.aws/b3v0x0o0/cjs-edu:0.0.3', ttyEnabled: true,),
        containerTemplate(name: 'podman', image: 'public.ecr.aws/b3v0x0o0/cjs-edu:0.0.4', ttyEnabled: true, command: 'cat', privileged:true)
  ]) {
    node(label) {
        stage('Get Source') {
            container('maven') {
                sh"""
                mvn --version
                git clone https://icistrsa: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@github.com/icistrsa/cicd_repository.git
                cd cicd_repository/repository/test
                mvn clean package
                """
            }
        }
/*
        stage('Build & push') {
            container('podman') {
                    sh """
                    cd base-project/sample/hello-world-spring/demo
                    podman login -u ${NEXUS_USERNAME} -p ${NEXUS_PASSWORD} ${NEXUS_HOST} --tls-verify=false
                    podman build -t ${NEXUS_HOST}/${USER_IDENTITY}/spring-jenkins:1.0.0 --cgroup-manager=cgroupfs --tls-verify=false .
                    podman push ${NEXUS_HOST}/${USER_IDENTITY}/spring-jenkins:1.0.0  --tls-verify=false
                    """
            }
        }

                
        stage('gitOps Update') {
            container('podman') {
            sh"""
            cd base-project/sample/gitops/hello-world-spring

            git config --global user.email "jenkins@example.com"
            git config --global user.name "Jenkins Pipeline"

            kustomize edit set image ${NEXUS_HOST}/${USER_IDENTITY}/spring-jenkins:1.0.0

            git add .
            git commit -am 'update  from Jenkins'
            git push http://${USER_IDENTITY}:${GIT_TOKEN}@gitlab.35.209.207.26.nip.io/${USER_IDENTITY}/base-project.git
            """
            }
        }
                */
    }
}
